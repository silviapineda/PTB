rm(list = ls(all = TRUE))
x<-date()
print(x)
###########################################################################################
### PROJECT: EMR PTB diags
###
### CITATION: 
###
### PROCESS: Longitudinal data analysis. ENET for longitudinal data with all the data for the lab test
###           
### DESCRIP: Separate in training and testing 10 times and run glmmLasso
###         
###
### Author: Silvia Pineda
### Date: August, 2018
############################################################################################
library(lattice)
library(lme4)
library("RColorBrewer")
library(ggplot2)
library(caret)
library(glmmLasso)

working_directory<-"/Users/Pinedasans/PTB/"
setwd(working_directory)

#############################
### Multivariate model  #####
############################
##First: Put everything needed in the same dataframe
load("Data/EMR_long_diags_multi.Rdata")

demographics<-read.csv("Data/EMR_patients_patient_race_filtered.csv") 
demographics$Patient_Marital_Status<-gsub("RDP-Dissolved","Unknown/Declined",demographics$Patient_Marital_Status)
demographics$Patient_Marital_Status<-gsub("RDP-LG SEP","Unknown/Declined",demographics$Patient_Marital_Status)
demographics$Patient_Marital_Status<-gsub("Widowed","Unknown/Declined",demographics$Patient_Marital_Status)

demographics$Patient_Smoking_Status<-gsub("Heavy Tobacco Smoker","Current Every Day Smoker",demographics$Patient_Smoking_Status)
demographics$Patient_Smoking_Status<-gsub("Never Assessed","Unknown/NeverAssesed",demographics$Patient_Smoking_Status)
demographics$Patient_Smoking_Status<-gsub("Unknown If Ever Smoked","Unknown/NeverAssesed",demographics$Patient_Smoking_Status)
demographics$Patient_Smoking_Status<-gsub("Smoker, Current Status Unknown","Unknown/NeverAssesed",demographics$Patient_Smoking_Status)

EMR_long_diags_multivariate$ID<-rownames(EMR_long_diags_multivariate)
EMR_diags_demo<-merge(EMR_long_diags_multivariate,demographics,by="Patient_index")
EMR_diags_demo<-subset(EMR_diags_demo,select = -c(ID,X,Term.y))
colnames(EMR_diags_demo)[2]<-"Term"
# ##near Zero Variance correction
EMR_diags_demo_filter<-EMR_diags_demo ##

# ##To extract the names of the variables for the glmmLasso
paste(colnames(EMR_diags_demo_filter)[1:400],collapse ="+")
paste(colnames(EMR_diags_demo_filter)[401:ncol(EMR_diags_demo_filter)],collapse ="+")
####################################
##  Run glmmLasso for the multi  ##
###################################

##Number of unique patient_index to obtain the train and test set
set.seed(54)
EMR_long_diags_patient<-EMR_diags_demo[match(unique(EMR_diags_demo_filter$Patient_index),EMR_diags_demo_filter$Patient_index)
                                     ,c("Term","Patient_index")]
table(EMR_long_diags_patient[,"Term"])
dim_term<-table(EMR_long_diags_patient[,"Term"])[1] ##8648 unique Term
dim_ptb<-table(EMR_long_diags_patient[,"Term"])[2]  ##414 unique PTB

predictions<-list() 
original<-list()
for( i in 1:10){
  print(paste("Sample ", i,sep=""))
  id_test_data_PTB<-sample(c(1:dim_ptb),0.2*dim_ptb) ##20% of PTB
  EMR_test_PTB<-EMR_long_diags_patient[which(EMR_long_diags_patient$Term==1)[id_test_data_PTB],]
  id_test_data_Term<-sample(c(1:dim_term),0.2*dim_term) ##20% of term
  EMR_test_Term<-EMR_long_diags_patient[which(EMR_long_diags_patient$Term==0)[id_test_data_Term],]
  
  EMR_test_data<-rbind(EMR_test_PTB,EMR_test_Term)
  id_test_data<-unlist(lapply(EMR_test_data$Patient_index, function(x) grep(x,EMR_diags_demo_filter$Patient_index)))
  EMR_long_diags_test<-EMR_diags_demo_filter[id_test_data,] 
  EMR_long_diags_train<-EMR_diags_demo_filter[-(id_test_data),] 
  
  lambda <- seq(100,0,by=-5)
  family = binomial(link = logit)
  ################## First Simple Method ############################################
  ## Using BIC (or AIC, respectively) to determine the optimal tuning parameter lambda
  
  BIC_vec<-rep(Inf,length(lambda))
  
  for(j in 1:length(lambda)){
    print(paste("Iteration ", j,sep=""))
    glm1 <- try(glmmLasso(Term ~A49.1+A49.9+A60.00+A60.09+A60.9+A63.0+A74.9+A92.5+B00.2+B00.9+B02.9+B06.9+B07.0+B07.9+B18.1+B18.2+B19.10+B19.20+B20+B34.9+B35.3+B37.2+B37.3+B37.9+B95.1+B96.89+B97.7+B97.89+C73+D06.9+D18.01+D21.9+D22.5+D22.9+D23.5+D23.9+D25.1+D25.9+D27.9+D48.5+D49.59+D50.8+D50.9+D53.9+D56.0+D56.3+D57.3+D58.2+D61.818+D63.1+D64.9+D68.0+D68.1+D68.2+D68.51+D68.52+D68.59+D68.61+D68.9+D69.3+D69.59+D69.6+D75.89+D89.9+E03.8+E03.9+E04.1+E04.9+E05.00+E05.90+E06.3+E07.9+E10.65+E10.9+E11.65+E11.9+E13.9+E28.2+E34.9+E55.9+E66.01+E66.3+E66.9+E72.12+E86.0+E88.09+E89.0+F10.10+F11.20+F12.10+F12.20+F12.90+F17.200+F17.210+F19.10+F19.20+F19.21+F31.9+F32.9+F33.0+F33.1+F33.40+F33.9+F34.1+F39+F41.0+F41.1+F41.8+F41.9+F43.0+F43.10+F43.20+F43.21+F43.22+F43.23+F43.29+F43.8+F43.9+F53+F90.9+F99+G35+G40.209+G40.909+G43.009+G43.109+G43.809+G43.909+G47.00+G47.33+G47.9+G51.0+G56.00+G56.01+G56.03+G89.29+H10.9+H52.13+H53.8+H53.9+H66.90+I05.9+I10+I12.9+I15.1+I25.10+I26.99+I27.2+I27.20+I27.89+I34.1+I35.0+I42.8+I42.9+I47.1+I48.91+I49.3+I49.8+I49.9+I51.9+I67.9+I78.1+I82.409+I83.90+I86.3+I86.8+IMO0001+IMO0002+J02.9+J06.9+J11.1+J30.1+J30.9+J32.9+J34.89+J44.9+J45.20+J45.30+J45.40+J45.901+J45.909+K02.9+K04.7+K21.9+K31.89+K42.9+K50.90+K51.90+K51.919+K52.9+K58.9+K59.00+K59.09+K63.89+K64.9+K76.89+K80.20+K83.1+K83.8+K90.0+L20.89+L20.9+L25.9+L29.2+L29.3+L29.8+L29.9+L30.9+L70.8+L70.9+L71.9+L73.8+L73.9+L81.4+L81.9+L82.1+L91.0+L91.8+L93.0+L98.8+L98.9+M06.9+M25.512+M25.519+M25.539+M25.551+M25.552+M25.559+M25.9+M32.14+M32.9+M35.00+M41.9+M45.9+M51.26+M53.3+M54.2+M54.30+M54.31+M54.32+M54.5+M54.9+M62.89+M79.1+M79.609+M79.89+M89.9+M94.9+N05.8+N12+N13.30+N18.2+N18.9+N20.0+N28.89+N28.9+N39.0+N39.3+N63+N63.0+N64.59+N76.0+N80.9+N81.84+N83.201+N83.202+N83.209+N84.1+N85.6+N87.9+N88.3+N89.8+N90.89+N92.0+N93.9+N94.89+N94.9+N97.9+O09.00+O09.03+O09.211+O09.212+O09.213+O09.219+O09.291+O09.292+O09.293+O09.299+O09.30+O09.32+O09.33+O09.40+O09.43+O09.511+O09.512+O09.513+O09.519+O09.521+O09.522+O09.523+O09.529+O09.623+O09.629+O09.73+O09.811+O09.812+O09.813+O09.819+O09.891+O09.892+O09.893+O09.899+O09.90+O09.91+O09.92+O09.93+O10.013+O10.019+O10.413+O10.912+O10.913+O10.919+O11.9+O12.03+O12.10+O12.13+O13.2+O13.3+O13.9+O14.03+O14.10+O14.13+O14.90+O14.93+O16.2+O16.3+O16.9+O20.0+O20.9+O21.0+O21.2+O21.9+O22.00+O22.03+O22.10+O22.13+O22.30+O22.33+O22.40+O22.43+O22.8X9+O23.00+O23.03+O23.40+O23.41+O23.42+O23.43+O23.593+O23.90+O24.013+O24.113+O24.119+O24.313+O24.319+O24.410+O24.414+O24.415+O24.419+O24.420+O24.424+O24.429+O24.912+O24.913+O24.919+O26.00+O26.03+O26.10+O26.13+O26.20+O26.23+O26.613+O26.619+O26.813+O26.833+O26.839+O26.842+O26.843+O26.849+O26.851+O26.852+O26.853+O26.859+O26.86+O26.872+O26.873+O26.879+O26.892+O26.893+
                            O26.899+O26.90+O26.93+O28.0+O28.1+O28.3+O28.5+O28.8+O28.9+O30.009+O30.90+O31.10X0+O32.1XX0+O32.1XX1+O32.2XX0+O32.9XX0+O33.7XX0+O34.00+O34.03+O34.10+O34.12+O34.13+O34.21+O34.211+O34.219+O34.29+O34.30+O34.32+O34.33+O34.40+O34.42+O34.43+O34.593+O34.599+O34.70+O34.83+O34.90+O35.0XX0+O35.0XX1+O35.1XX0+O35.2XX0+O35.2XX1+O35.3XX0+O35.5XX0+O35.8XX0+O35.8XX1+O35.8XX9+O35.9XX0+O35.9XX1+O36.0110+O36.0111+O36.0120+O36.0121+O36.0130+O36.0131+O36.0190+O36.0191+O36.0930+O36.0990+O36.5930+O36.5931+O36.5990+O36.60X0+O36.63X0+O36.63X1+O36.8130+O36.8131+O36.8190+O36.8390+O36.8930+O36.8990+O36.90X0+O36.93X0+O36.93X1+O40.3XX0+O40.3XX1+O40.9XX0+O41.00X0+O41.02X0+O41.03X0+O41.03X1+O41.8X90+O41.90X0+O42.90+O42.919+O43.103+O43.109+O43.113+O43.122+O43.123+O43.129+O43.193+O43.199+O43.893+O43.899+O43.90+O43.93+O44.00+O44.02+O44.03+O44.10+O44.12+O44.13+O44.20+O44.40+O44.42+O44.43+O45.90+O45.93+O46.8X2+O46.8X3+O46.8X9+O46.90+O46.92+O46.93+O47.00+O47.03+O47.9+O62.2+O62.9+O69.89X0+O69.9XX0+O69.9XX1+O71.6+O75.89+O76+O82+O90.3+O92.70+O92.79+O98.019+O98.312+O98.313+O98.319+O98.413+O98.419+O98.513+O98.519+O98.713+O98.813+O98.819+O99.011+O99.012+O99.013+O99.019+O99.113+O99.119+O99.12+O99.210+O99.213+O99.214+O99.280+O99.281+O99.282+O99.283+O99.320+O99.323+O99.330+O99.333+O99.340+O99.341+O99.342+O99.343+O99.350+O99.353+O99.412+O99.413+O99.419+O99.513+O99.519+O99.612+O99.613+O99.619+O99.713+O99.719+O99.810+O99.820+O99.840+O99.843+O99.89+O9A.319+P00.6+P01.3+P02.29+P02.60+P02.69+P03.819+P05.00+P05.9+P08.0+P08.1+P96.9+Q05.9+Q20.1+Q20.3+Q21.0+Q21.1+Q21.3+Q23.0+Q23.1+Q23.4+Q24.9+Q25.1+Q25.5+Q27.0+Q28.9+Q33.0+Q51.2+Q51.3+Q51.9+Q62.39+Q62.5+Q63.8+Q64.9+Q79.0+Q79.1+Q79.6+Q89.7+R00.0+R00.2+R01.1+R03.0+R04.0+R05+R06.00+R06.02+R06.09+R07.81+R07.89+R07.9+R09.02+R09.81+R09.89+R10.11+R10.13+R10.2+R10.30+R10.31+R10.32+R10.9+R11.0+R11.10+R11.2+R12+R19.7+R20.0+R20.2+R20.9+R21+R23.8+R25.2+R30.0+R31.9+R35.0+R39.89+R39.9+R42+R45.89+R50.9+R51+R52+R53.81+R53.83+R55+R56.9+R60.0+R60.9+R62.51+R63.5+R63.6+R68.89+R69+R71.8+R73.01+R73.02+R73.03+R73.09+R73.9+R74.0+R74.8+R76.11+R76.8+R77.2+R79.89+R80.9+R81+R82.71+R82.90+R82.99+R87.610+R87.611+R87.612+R87.613+R87.619+R87.810+R89.4+R89.6+R89.9+R91.8+R93.8+R94.31+R94.6+S89.90XA+T14.8+T14.8XXA+T74.11XA+V89.2XXA+W01.0XXA+W19.XXXA+Y92.099+Y92.410+Y92.9+Y99.8+Z00.00+Z00.6+Z01.30+Z01.818+Z01.89+Z02.89+Z02.9+Z03.71+Z03.72+Z03.74+Z04.3+Z11.1+Z11.3+Z11.59+Z12.4+Z13.1+Z13.6+Z13.71+Z13.79+Z13.89+Z13.9+Z14.1+Z14.8+Z20.2+Z20.828+Z20.9+Z21+Z22.330+Z23+Z28.20+Z28.21+Z28.3+Z28.89+Z29.13+Z29.8+Z30.09+Z30.2+Z30.9+Z31.5+Z31.83+Z33.1+Z34.00+Z34.01+Z34.02+Z34.03+Z34.80+Z34.81+Z34.82+Z34.83+Z34.90+Z34.91+Z34.92+Z34.93+Z36+Z36.3+Z36.85+Z36.9+Z38.2+Z39.1+Z39.2+Z41.8+Z51.81+Z52.001+Z53.1+Z59.0+Z59.8+Z59.9+Z60.3+Z60.9+Z63.0+Z63.79+Z64.1+Z65.8+Z65.9+Z67.11+Z67.41+Z67.91+Z68.27+Z68.28+Z68.30+Z68.31+Z68.32+Z68.35+Z68.36+Z68.41+Z68.42+Z68.43+Z71.3+Z71.89+Z72.0+Z73.3+Z73.6+Z76.81+Z76.89+Z78.9+Z79.01+Z79.4+Z79.82+Z79.899+Z80.3+Z80.8+Z82.49+Z82.79+Z83.2+Z83.3+Z83.49+Z84.81+Z84.89+Z85.850+Z86.19+Z86.2+Z86.32+Z86.39+Z86.59+Z86.69+Z86.711+Z86.718+Z86.73+Z86.79+Z87.09+Z87.19+Z87.410+Z87.42+Z87.440+Z87.448+Z87.51+Z87.59+Z87.74+Z87.798+Z87.891+Z87.898+Z88.0+Z88.5+Z88.8+Z90.49+Z91.89+Z94.0+Z96.41+Z98.51+Z98.82+Z98.84+Z98.89+Z98.890+Z98.891+Patient_Ethnicity+Patient_Marital_Status+Patient_Smoking_Status+Patient_Age+Patient_Race
                          ,rnd = list(Patient_index=~1),family = family, data = EMR_long_diags_train, lambda=lambda[j]),silent=TRUE)  
    if(class(glm1)!="try-error"){  
      BIC_vec[j]<-glm1$bic
    }
  }
  
  opt<-which.min(BIC_vec)
  glm_final <- glmmLasso(Term ~ A49.1+A49.9+A60.00+A60.09+A60.9+A63.0+A74.9+A92.5+B00.2+B00.9+B02.9+B06.9+B07.0+B07.9+B18.1+B18.2+B19.10+B19.20+B20+B34.9+B35.3+B37.2+B37.3+B37.9+B95.1+B96.89+B97.7+B97.89+C73+D06.9+D18.01+D21.9+D22.5+D22.9+D23.5+D23.9+D25.1+D25.9+D27.9+D48.5+D49.59+D50.8+D50.9+D53.9+D56.0+D56.3+D57.3+D58.2+D61.818+D63.1+D64.9+D68.0+D68.1+D68.2+D68.51+D68.52+D68.59+D68.61+D68.9+D69.3+D69.59+D69.6+D75.89+D89.9+E03.8+E03.9+E04.1+E04.9+E05.00+E05.90+E06.3+E07.9+E10.65+E10.9+E11.65+E11.9+E13.9+E28.2+E34.9+E55.9+E66.01+E66.3+E66.9+E72.12+E86.0+E88.09+E89.0+F10.10+F11.20+F12.10+F12.20+F12.90+F17.200+F17.210+F19.10+F19.20+F19.21+F31.9+F32.9+F33.0+F33.1+F33.40+F33.9+F34.1+F39+F41.0+F41.1+F41.8+F41.9+F43.0+F43.10+F43.20+F43.21+F43.22+F43.23+F43.29+F43.8+F43.9+F53+F90.9+F99+G35+G40.209+G40.909+G43.009+G43.109+G43.809+G43.909+G47.00+G47.33+G47.9+G51.0+G56.00+G56.01+G56.03+G89.29+H10.9+H52.13+H53.8+H53.9+H66.90+I05.9+I10+I12.9+I15.1+I25.10+I26.99+I27.2+I27.20+I27.89+I34.1+I35.0+I42.8+I42.9+I47.1+I48.91+I49.3+I49.8+I49.9+I51.9+I67.9+I78.1+I82.409+I83.90+I86.3+I86.8+IMO0001+IMO0002+J02.9+J06.9+J11.1+J30.1+J30.9+J32.9+J34.89+J44.9+J45.20+J45.30+J45.40+J45.901+J45.909+K02.9+K04.7+K21.9+K31.89+K42.9+K50.90+K51.90+K51.919+K52.9+K58.9+K59.00+K59.09+K63.89+K64.9+K76.89+K80.20+K83.1+K83.8+K90.0+L20.89+L20.9+L25.9+L29.2+L29.3+L29.8+L29.9+L30.9+L70.8+L70.9+L71.9+L73.8+L73.9+L81.4+L81.9+L82.1+L91.0+L91.8+L93.0+L98.8+L98.9+M06.9+M25.512+M25.519+M25.539+M25.551+M25.552+M25.559+M25.9+M32.14+M32.9+M35.00+M41.9+M45.9+M51.26+M53.3+M54.2+M54.30+M54.31+M54.32+M54.5+M54.9+M62.89+M79.1+M79.609+M79.89+M89.9+M94.9+N05.8+N12+N13.30+N18.2+N18.9+N20.0+N28.89+N28.9+N39.0+N39.3+N63+N63.0+N64.59+N76.0+N80.9+N81.84+N83.201+N83.202+N83.209+N84.1+N85.6+N87.9+N88.3+N89.8+N90.89+N92.0+N93.9+N94.89+N94.9+N97.9+O09.00+O09.03+O09.211+O09.212+O09.213+O09.219+O09.291+O09.292+O09.293+O09.299+O09.30+O09.32+O09.33+O09.40+O09.43+O09.511+O09.512+O09.513+O09.519+O09.521+O09.522+O09.523+O09.529+O09.623+O09.629+O09.73+O09.811+O09.812+O09.813+O09.819+O09.891+O09.892+O09.893+O09.899+O09.90+O09.91+O09.92+O09.93+O10.013+O10.019+O10.413+O10.912+O10.913+O10.919+O11.9+O12.03+O12.10+O12.13+O13.2+O13.3+O13.9+O14.03+O14.10+O14.13+O14.90+O14.93+O16.2+O16.3+O16.9+O20.0+O20.9+O21.0+O21.2+O21.9+O22.00+O22.03+O22.10+O22.13+O22.30+O22.33+O22.40+O22.43+O22.8X9+O23.00+O23.03+O23.40+O23.41+O23.42+O23.43+O23.593+O23.90+O24.013+O24.113+O24.119+O24.313+O24.319+O24.410+O24.414+O24.415+O24.419+O24.420+O24.424+O24.429+O24.912+O24.913+O24.919+O26.00+O26.03+O26.10+O26.13+O26.20+O26.23+O26.613+O26.619+O26.813+O26.833+O26.839+O26.842+O26.843+O26.849+O26.851+O26.852+O26.853+O26.859+O26.86+O26.872+O26.873+O26.879+O26.892+O26.893+
                           O26.899+O26.90+O26.93+O28.0+O28.1+O28.3+O28.5+O28.8+O28.9+O30.009+O30.90+O31.10X0+O32.1XX0+O32.1XX1+O32.2XX0+O32.9XX0+O33.7XX0+O34.00+O34.03+O34.10+O34.12+O34.13+O34.21+O34.211+O34.219+O34.29+O34.30+O34.32+O34.33+O34.40+O34.42+O34.43+O34.593+O34.599+O34.70+O34.83+O34.90+O35.0XX0+O35.0XX1+O35.1XX0+O35.2XX0+O35.2XX1+O35.3XX0+O35.5XX0+O35.8XX0+O35.8XX1+O35.8XX9+O35.9XX0+O35.9XX1+O36.0110+O36.0111+O36.0120+O36.0121+O36.0130+O36.0131+O36.0190+O36.0191+O36.0930+O36.0990+O36.5930+O36.5931+O36.5990+O36.60X0+O36.63X0+O36.63X1+O36.8130+O36.8131+O36.8190+O36.8390+O36.8930+O36.8990+O36.90X0+O36.93X0+O36.93X1+O40.3XX0+O40.3XX1+O40.9XX0+O41.00X0+O41.02X0+O41.03X0+O41.03X1+O41.8X90+O41.90X0+O42.90+O42.919+O43.103+O43.109+O43.113+O43.122+O43.123+O43.129+O43.193+O43.199+O43.893+O43.899+O43.90+O43.93+O44.00+O44.02+O44.03+O44.10+O44.12+O44.13+O44.20+O44.40+O44.42+O44.43+O45.90+O45.93+O46.8X2+O46.8X3+O46.8X9+O46.90+O46.92+O46.93+O47.00+O47.03+O47.9+O62.2+O62.9+O69.89X0+O69.9XX0+O69.9XX1+O71.6+O75.89+O76+O82+O90.3+O92.70+O92.79+O98.019+O98.312+O98.313+O98.319+O98.413+O98.419+O98.513+O98.519+O98.713+O98.813+O98.819+O99.011+O99.012+O99.013+O99.019+O99.113+O99.119+O99.12+O99.210+O99.213+O99.214+O99.280+O99.281+O99.282+O99.283+O99.320+O99.323+O99.330+O99.333+O99.340+O99.341+O99.342+O99.343+O99.350+O99.353+O99.412+O99.413+O99.419+O99.513+O99.519+O99.612+O99.613+O99.619+O99.713+O99.719+O99.810+O99.820+O99.840+O99.843+O99.89+O9A.319+P00.6+P01.3+P02.29+P02.60+P02.69+P03.819+P05.00+P05.9+P08.0+P08.1+P96.9+Q05.9+Q20.1+Q20.3+Q21.0+Q21.1+Q21.3+Q23.0+Q23.1+Q23.4+Q24.9+Q25.1+Q25.5+Q27.0+Q28.9+Q33.0+Q51.2+Q51.3+Q51.9+Q62.39+Q62.5+Q63.8+Q64.9+Q79.0+Q79.1+Q79.6+Q89.7+R00.0+R00.2+R01.1+R03.0+R04.0+R05+R06.00+R06.02+R06.09+R07.81+R07.89+R07.9+R09.02+R09.81+R09.89+R10.11+R10.13+R10.2+R10.30+R10.31+R10.32+R10.9+R11.0+R11.10+R11.2+R12+R19.7+R20.0+R20.2+R20.9+R21+R23.8+R25.2+R30.0+R31.9+R35.0+R39.89+R39.9+R42+R45.89+R50.9+R51+R52+R53.81+R53.83+R55+R56.9+R60.0+R60.9+R62.51+R63.5+R63.6+R68.89+R69+R71.8+R73.01+R73.02+R73.03+R73.09+R73.9+R74.0+R74.8+R76.11+R76.8+R77.2+R79.89+R80.9+R81+R82.71+R82.90+R82.99+R87.610+R87.611+R87.612+R87.613+R87.619+R87.810+R89.4+R89.6+R89.9+R91.8+R93.8+R94.31+R94.6+S89.90XA+T14.8+T14.8XXA+T74.11XA+V89.2XXA+W01.0XXA+W19.XXXA+Y92.099+Y92.410+Y92.9+Y99.8+Z00.00+Z00.6+Z01.30+Z01.818+Z01.89+Z02.89+Z02.9+Z03.71+Z03.72+Z03.74+Z04.3+Z11.1+Z11.3+Z11.59+Z12.4+Z13.1+Z13.6+Z13.71+Z13.79+Z13.89+Z13.9+Z14.1+Z14.8+Z20.2+Z20.828+Z20.9+Z21+Z22.330+Z23+Z28.20+Z28.21+Z28.3+Z28.89+Z29.13+Z29.8+Z30.09+Z30.2+Z30.9+Z31.5+Z31.83+Z33.1+Z34.00+Z34.01+Z34.02+Z34.03+Z34.80+Z34.81+Z34.82+Z34.83+Z34.90+Z34.91+Z34.92+Z34.93+Z36+Z36.3+Z36.85+Z36.9+Z38.2+Z39.1+Z39.2+Z41.8+Z51.81+Z52.001+Z53.1+Z59.0+Z59.8+Z59.9+Z60.3+Z60.9+Z63.0+Z63.79+Z64.1+Z65.8+Z65.9+Z67.11+Z67.41+Z67.91+Z68.27+Z68.28+Z68.30+Z68.31+Z68.32+Z68.35+Z68.36+Z68.41+Z68.42+Z68.43+Z71.3+Z71.89+Z72.0+Z73.3+Z73.6+Z76.81+Z76.89+Z78.9+Z79.01+Z79.4+Z79.82+Z79.899+Z80.3+Z80.8+Z82.49+Z82.79+Z83.2+Z83.3+Z83.49+Z84.81+Z84.89+Z85.850+Z86.19+Z86.2+Z86.32+Z86.39+Z86.59+Z86.69+Z86.711+Z86.718+Z86.73+Z86.79+Z87.09+Z87.19+Z87.410+Z87.42+Z87.440+Z87.448+Z87.51+Z87.59+Z87.74+Z87.798+Z87.891+Z87.898+Z88.0+Z88.5+Z88.8+Z90.49+Z91.89+Z94.0+Z96.41+Z98.51+Z98.82+Z98.84+Z98.89+Z98.890+Z98.891+Patient_Ethnicity+Patient_Marital_Status+Patient_Smoking_Status+Patient_Age+Patient_Race
                         ,rnd = list(Patient_index=~1),family = family, data = EMR_long_diags_test, lambda=lambda[opt])
  summary(glm_final)
  
  predictions[[i]] <- predict(glm_final, EMR_long_diags_test, type="response",s=lambda[opt])
  original[[i]]<-EMR_long_diags_test$Term
}
save(predictions,original,file="Results/predictions_multi_diags.Rdata")



####
## Analysis Results
####
load("Results/predictions_multi_diags.Rdata")
library(AUC)
auc<-NULL

for(i in 1:10){
  auc[i]<-auc(roc(predictions[[i]],factor(original[[i]])))
}

conf_matrix<-table(round(predictions[[i]]),factor(original[[i]]))
conf_matrix
sensitivity(conf_matrix)
specificity(conf_matrix)

tiff("Results/AUC_multi_diags.tiff",res=300,w=2000,h=2000)
roc1<-roc(predictions[[1]],factor(original[[1]]))
plot(roc1, col = 1, lty = 2, main = "ROC diags")

for (i in 2:10){
  roci<-roc(predictions[[i]],factor(original[[i]]))
  plot(roci, col = i, lty = 3, add = TRUE)
}
dev.off()
